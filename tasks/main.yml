# https://github.com/drduh/YubiKey-Guide#ssh
- apt:
    pkg:
    - gnupg2
    - gnupg-agent
    - dirmngr
    - cryptsetup
    - scdaemon
    - pcscd
    - secure-delete
    - hopenpgp-tools
    - yubikey-personalization
  become: yes

- name: Add an apt key by id from a keyserver
  apt_key:
    keyserver: "{{ item.keyserver }}"
    id: "{{ item.keyId }}"
  with_items: "{{ yubikey_gpg_keys_to_import }}"

- template:
  src: templates/gpg-agent.conf.j2
  dest: ~/.gnupg/gpg-agent.conf

- lineinfile:
    dest: "~/.bashrc"
    create: yes
    state: present
    line: "export GPG_TTY=\"$(tty)\""
    regexp: "^export GPG_TTY"

- lineinfile:
    dest: "~/.bashrc"
    create: yes
    state: present
    line: "export SSH_AUTH_SOCK=$(gpgconf --list-dirs agent-ssh-socket)"
    regexp: "^export SSH_AUTH_SOCK"

- lineinfile:
    dest: "~/.bashrc"
    create: yes
    state: present
    line: "gpgconf --launch gpg-agent"
    regexp: "^gpgconf --launch"

- shell: gpg-connect-agent reloadagent /bye
